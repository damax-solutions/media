{% block damax_media_javascript %}
    <script type="text/javascript">
        $(function () {
            var $delete = function () {
                var $elem = $(this)

                if (confirm('{{ 'media.message.confirm_removal' | trans({}, 'damax-media') }}')) {
                    $.ajax({
                        url: $elem.attr('href'),
                        type: 'DELETE',
                        success: function () {
                            $elem.parents('.media-item').fadeOut(function () {
                                $(this).remove()
                            })
                        }
                    })
                }

                return false
            }

            var $modal = $('#{{ id }}-upload')

            {% set params = { multiple: multiple, full_name: full_name, image_params: image_params } | json_encode %}

            // Delete media
            $('#{{ id }} .media-delete').on('click', $delete)

            // Create media
            $('.media-upload', $modal).click(function () {
                var $file = $('#{{ id }}-upload .media-file')
                var files = $file.prop('files')

                if (files.length) {
                    var file = files[0]

                    $file.val('')

                    $modal.modal('hide')

                    $.ajax({
                        url: '{{ path('media_create') }}',
                        type: 'POST',
                        dataType: 'json',
                        contentType: 'application/json',
                        data: JSON.stringify({ type: '{{ type_name }}', name: file.name }),
                        headers: {
                            'X-Upload-Content-Type': file.type,
                            'X-Upload-Content-Length': file.size
                        },
                        success: function (response) {
                            $.ajax({
                                url: '{{ path('media_upload', { id: '__id__', params: params }) | raw }}'.replace(/__id__/, response.id),
                                type: 'PUT',
                                contentType: file.type,
                                data: file,
                                processData: false,
                                headers: {
                                    'Accept': 'text/html'
                                },
                                success: function (response) {
                                    $('#{{ id }}-new').before(response)

                                    // Delete media
                                    $('#{{ id }} .media-delete').last().on('click', $delete)
                                }
                            })
                        }
                    })
                }

                return false
            })
        })
    </script>
{% endblock %}
